#!/bin/bash

# Server list
SERVERS=("server1" "server2" "server3")
SSH_USER="your_ssh_user"
FAILED_SERVERS=()

for SERVER in "${SERVERS[@]}"
do
    echo "Checking UDeploy agent on $SERVER..."
    HOSTNAME=$(ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER "hostname")

    if ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER 'ps -eo user,pid,command | grep urban | grep -v grep | grep rmpci > /dev/null'; then
        echo "ALERT: Unauthorized UDeploy agent is running on $HOSTNAME"
        FAILED_SERVERS+=("$HOSTNAME")
    fi
done

if [ ${#FAILED_SERVERS[@]} -gt 0 ]; then
    FAILED_SERVERS_LIST=$(IFS=,; echo "${FAILED_SERVERS[*]}")
    echo "FAILED_SERVERS_LIST=$FAILED_SERVERS_LIST" > $WORKSPACE/env.properties  # Save to file for Jenkins
    exit 1
fi