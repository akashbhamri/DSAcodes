#!/bin/bash

# List of remote servers (IP or hostname)
SERVERS=("server1" "server2" "server3")
SSH_USER="your_ssh_user"

# Array to hold any unauthorized hosts found
UNAUTHORIZED_HOSTS=()

for SERVER in "${SERVERS[@]}"
do
    echo "Checking UDeploy agent on $SERVER..."
    
    # Get the remote machine's actual hostname
    REMOTE_HOSTNAME=$(ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER "hostname")

    # Check if 'rmpci' is running the udeploy agent
    if ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER \
       'ps -eo user,pid,command | grep urban | grep -v grep | grep rmpci > /dev/null'; then
        echo "ALERT: Unauthorized UDeploy agent is running on $REMOTE_HOSTNAME"
        UNAUTHORIZED_HOSTS+=("$REMOTE_HOSTNAME")
    fi
done

# If any unauthorized usage is found, fail the build and print them
if [ ${#UNAUTHORIZED_HOSTS[@]} -gt 0 ]; then
    # Print the hostnames in a single line so Jenkins can parse them
    echo "HOSTNAMES: ${UNAUTHORIZED_HOSTS[@]}"
    exit 1
else
    echo "No unauthorized usage found."
    exit 0
fi




The following server(s) have an unauthorized UDeploy agent (running as rmpci):

${BUILD_LOG_REGEX, regex="HOSTNAMES:(.*)", maxMatches=1, showTruncatedLines=false}

Please investigate immediately!

Job Name: ${JOB_NAME}
Build Number: ${BUILD_NUMBER}
Build URL: ${BUILD_URL}