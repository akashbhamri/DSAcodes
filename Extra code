#!/bin/bash

# Get server IPs from the first argument (passed by Jenkins)
SERVER_IPS=$1
# Output CSV file
OUTPUT_CSV="docker_root_dirs.csv"

# Write the CSV header
echo "Hostname,Docker Root Dir" > "$OUTPUT_CSV"

# Loop through each server IP (assuming multiple IPs are passed as comma-separated values)
IFS=',' read -r -a ip_array <<< "$SERVER_IPS"

for server_ip in "${ip_array[@]}"; do
    # Get the hostname from the server
    hostname=$(ssh -o BatchMode=yes -o ConnectTimeout=5 "$server_ip" "hostname" 2>/dev/null)
    
    if [ -z "$hostname" ]; then
        echo "Failed to connect to $server_ip or retrieve hostname"
        continue
    fi
    
    # Get the Docker root directory
    docker_root_dir=$(ssh -o BatchMode=yes -o ConnectTimeout=5 "$server_ip" "docker info --format '{{.DockerRootDir}}'" 2>/dev/null)
    
    if [ -z "$docker_root_dir" ]; then
        docker_root_dir="N/A"
    fi
    
    # Append the result to the CSV file
    echo "$hostname,$docker_root_dir" >> "$OUTPUT_CSV"
done

echo "Results saved to $OUTPUT_CSV"
