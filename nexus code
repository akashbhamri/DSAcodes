#!/bin/bash

# Nexus Repository Manager details
NEXUS_URL="https://nexus.app.syfbank.com:8443"
CREDENTIALS="username:password"

# Output file
OUTPUT_FILE="nexus_repositories_$(date +%Y%m%d_%H%M%S).csv"

# Function to list repositories with name, format, and blob store
list_repositories() {
  echo "Fetching list of repositories from Nexus..."

  response=$(curl -u $CREDENTIALS -X GET "$NEXUS_URL/service/rest/v1/repositories" -s)
  http_status=$(echo "$response" | jq -r '. | length')  # Check if JSON is returned

  if [ "$http_status" -ge 1 ]; then
    # Write CSV header
    echo "Repository Name,Format,Blob Store" > $OUTPUT_FILE
    
    # Extract and write repository details
    echo "$response" | jq -r '.[] | [.name, .format, .configuration["storage"]["blobStoreName"]] | @csv' >> $OUTPUT_FILE

    echo "Repositories list saved to $OUTPUT_FILE"
  else
    echo "Failed to fetch repositories. Check your Nexus URL, credentials, and try again."
  fi
}

# Call the function to list repositories
list_repositories
